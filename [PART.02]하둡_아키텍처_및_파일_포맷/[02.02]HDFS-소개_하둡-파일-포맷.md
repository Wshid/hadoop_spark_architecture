## 2.2. HDFS 소개 & 하둡 파일 포맷

### HDFS Introduction
- Hadoop의 스토리지 계층
- 분산 파일 시스템 빠르게 분산 처리하는 것에 대한 최적화
- 큰 파일을 클러스터 다른 서버에 **블록 청크**로 분할
  - 블록 크기, Hadoop 2.x부터 128MB
- seek time을 줄이기 위해
  - **블록 크기**가 크면
  - 추가 seek 오버헤드 없이, 한 seek에서 읽을 수 있는 데이터양 증가
- 분산 파일 시스템에 대한 블록 추상화
  - 네트워크의 **단일 디스크**보다 클 수 있으므로
  - 유용하게도, 클러스터의 **모든 디스크**에 **블록** 저장 가능
- **블록 크기**가 너무 작다면
  - nameNode에 대해 너무 많은 작업을 생성하는 **많은 분할**이 발생
- **블록 크기**가 크면
  - 하나의 `mapper`에 의해 처리되므로
- **블록 크기가 적으면**, 클러스터의 모든 노드가 사용되지 않을 수 있음
  - 클러스터 병렬 처리에 덜 활용
- 상황에 따라 `256M`이나 `1G`의 HDFS block size를 사용하는 경우도 존재
- `singed 32bit integer overflow` 이슈로
  - `블록 크기 > 2G` X
- 수십 밀리초의 `data read latency requirement`가 있는 것이 아니라면
  - HDFS는 스트리밍 데이터에 이상적
- `Replication factor of three`
  - 수집하는 모든 데이터의 3개 사본 유지
  - 많은 데이터 노드가 있는 랙 다운시
    - 가용성이 높은지 확인하는 것
    - 하나다 다운되어도 2개의 랙에 카피들이 남음

### Hadoop File Formats
- 행 기반 형식
  - 많은 열이 있는 **전체 단일 레코드**처리시 사용
- 열 기반 형식
  - 쿼리가 집계를 수행하기 위해
  - 테이블의 **소수의 열**에만 액세스시 사용
- 파일형식의 공통 특징
  - 읽기/쓰기 최적화 시도
  - 압축 허용
  - 모두 분할 가능
  - 스키마 진화 허용
    - 열 추가, 업데이트, 삭제
    - 스키마 변경이 가능하다는 의미

#### 행 기반 형식
- `Sequence file`
  - 원래 `MR`용으로 설계
  - HDFS에 기본적으로 통합
  - 각 레코드에 대한 `key, value`를 인코딩
  - 레코드는 **텍스트 기반 형식**보다 작은 **이진 형식**으로 저장
  - key,value의 **구조**를 인코딩 하지 않으므로
    - 스키마 마이그레이션 수행시 추가 필요
  - **블록 수준 압축 지원**
    - 여러 맵 작업을 위해
    - 파일을 segment로 분할하는 기능 유지하면서, 파일 내용 압축 가능
- xml, csv, json과 같은 파일은 **데이터 쿼리에 적합하지 않음**
- csv를 제외하고 분할할수 없다는 점에서
  - **블록 압축**을 지원하지 않음
- 데이터를 로드 이후, `Dataframe` 및 `RDD`로 변환하는 이유
- `Avro`
  - 가장 인기 있는 행 기반 직렬화 형식
  - **복잡한 객체**를 기본적으로 저장할 수 있도록
    - **파일에 직접 해당 내용의 스키마 인코딩**
  - **스키마**는 추가 처리를 위해 `Avro` 데이터와 함께 파일에 저장
  - 스키마 변경이 있을 때
    - **Click Stream/Event 데이터 형식**에 가장 적합
  - `Avro`에는 `Trevni`라는 열 기반 형식도 존재

#### 열 기반 형식
- `Parquet`
  - 컬럼 기반으로 저장된 바이너리 형식
  - **쓰기 측면**에서 계산 집약적
  - **읽기 측면**에서 성능을 높이기 위해 많은 IO 비용을 줄임
  - nested 구조 지원
- `ORC`
  - spark가 데이터를 처리할 때 제일 좋음
  - Optimized Row Columnar
  - **행 모음**을 저장하고, 행 내에서 데이터는 **열 형식**으로 저장
  - `ORC`는 원본 데이터의 크기를 최대 75%까지 줄임
  - 데이터 처리 속도 증가
  - **단순한 행 기반 파일 형식보다 좋은 형식**
  - `Hive`가 데이터를 처리할 때 제일 좋음
  - **관계형 데이터**를 저장하는 매우 효율적인 방법 제공
  - 관계형 데이터의 압축을 푸는데 걸리는 시간을 늘려
    - CPU Overhead 증가
    - **읽기 성능 저하**